<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Suggestions - SoilSense</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.2rem; color: #4ade80; margin-bottom: 8px; }
        header p { color: #94a3b8; font-size: 0.95rem; }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 8px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            transition: all 0.3s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .nav-links a:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-links a.active { background: #4ade80; color: #000; font-weight: 600; }
        
        /* CATEGORY TABS */
        .category-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .category-tab {
            padding: 10px 18px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .category-tab:hover { 
            background: rgba(255,255,255,0.1); 
            border-color: rgba(74, 222, 128, 0.3);
        }
        .category-tab.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000;
            border-color: #4ade80;
            transform: translateY(-2px);
        }
        
        .season-card {
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 25px;
            text-align: center;
        }
        .season-card.wet {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.3), rgba(59, 130, 246, 0.2));
            border: 1px solid rgba(14, 165, 233, 0.3);
        }
        .season-card.dry {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.2));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .season-icon { font-size: 3.5rem; margin-bottom: 12px; }
        .season-title { font-size: 1.6rem; font-weight: bold; margin-bottom: 8px; }
        .season-months { color: #94a3b8; font-size: 0.95rem; margin-bottom: 10px; }
        .season-desc { color: #cbd5e1; font-size: 0.9rem; line-height: 1.5; }
        
        .soil-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
            text-align: center;
        }
        .soil-card h3 { color: #94a3b8; font-size: 0.85rem; margin-bottom: 15px; font-weight: 600; }
        .soil-value { font-size: 2.5rem; font-weight: bold; color: #4ade80; line-height: 1.2; }
        .soil-label { color: #94a3b8; font-size: 0.85rem; }
        
        .suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .suggestions-header h2 { color: #fff; font-size: 1.3rem; }
        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Slider Container */
        .slider-container {
            position: relative;
            overflow: hidden;
            padding: 10px 0;
        }
        .slider-wrapper {
            display: flex;
            transition: transform 0.4s ease;
        }
        .slide {
            min-width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .slider-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 25px;
        }
        .slider-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slider-btn:hover { background: #4ade80; color: #000; }
        .slider-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .slider-btn:disabled:hover { background: rgba(255,255,255,0.1); color: #fff; }
        
        .slider-dots {
            display: flex;
            gap: 8px;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        .dot.active { background: #4ade80; transform: scale(1.2); }
        .dot:hover { background: rgba(255,255,255,0.4); }
        
        .slide-counter {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .crop-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 520px;
            margin: 0 auto;
        }
        
        .crop-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .crop-icon {
            font-size: 3rem;
            background: rgba(0,0,0,0.3);
            width: 72px;
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            flex-shrink: 0;
        }
        .crop-info h3 { color: #fff; font-size: 1.3rem; margin-bottom: 6px; font-weight: 600; }
        .crop-info .local-name { color: #94a3b8; font-size: 0.95rem; font-style: italic; margin-bottom: 10px; }
        .crop-score { display: flex; align-items: center; gap: 10px; }
        .score-bar { width: 100px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .score-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .score-fill.high { background: #4ade80; }
        .score-fill.medium { background: #fbbf24; }
        .score-fill.low { background: #f87171; }
        .score-text { font-size: 0.9rem; color: #94a3b8; }
        
        .crop-season-tag { display: inline-block; padding: 6px 14px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; }
        .crop-season-tag.wet { background: rgba(14, 165, 233, 0.3); color: #7dd3fc; }
        .crop-season-tag.dry { background: rgba(245, 158, 11, 0.3); color: #fcd34d; }
        .crop-season-tag.both { background: rgba(139, 92, 246, 0.3); color: #c4b5fd; }
        
        .crop-description { color: #e2e8f0; font-size: 1rem; margin-bottom: 15px; line-height: 1.6; }
        
        .crop-tips {
            background: rgba(74, 222, 128, 0.1);
            border-left: 4px solid #4ade80;
            padding: 18px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 20px;
        }
        .crop-tips .tip-label { 
            color: #4ade80; 
            font-size: 0.85rem; 
            font-weight: 600; 
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .crop-tips .tip-text { 
            color: #cbd5e1; 
            font-size: 0.95rem; 
            line-height: 1.8; 
        }
        
        .crop-soil {
            background: rgba(0,0,0,0.2);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }
        .crop-soil .label { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; }
        .crop-soil .value { font-size: 1.2rem; color: #4ade80; font-weight: 600; }
        
        .crop-reasons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .reason-tag { background: rgba(74, 222, 128, 0.2); color: #86efac; padding: 6px 12px; border-radius: 15px; font-size: 0.8rem; }
        
        /* ADD TO MY PLANTS BUTTON */
        .add-to-plants-btn {
            width: 100%;
            padding: 14px;
            background: #4ade80;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .add-to-plants-btn:hover {
            background: #22c55e;
            transform: translateY(-2px);
        }
        .add-to-plants-btn:disabled {
            background: rgba(255,255,255,0.1);
            color: #64748b;
            cursor: not-allowed;
            transform: none;
        }
        
        .slide-counter {
            color: #94a3b8;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 15px;
        }
        
        .no-suggestions { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .no-suggestions .icon { font-size: 4rem; margin-bottom: 20px; }
        .no-suggestions h3 { color: #fff; margin-bottom: 10px; }
        
        .loading { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .loading .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .info-note {
            text-align: center;
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 30px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .nav-links { gap: 10px; }
            .nav-links a { padding: 6px 12px; font-size: 0.85rem; }
            .category-tab { padding: 8px 14px; font-size: 0.85rem; }
            .season-card { padding: 24px; }
            .season-icon { font-size: 3rem; }
            .season-title { font-size: 1.4rem; }
            .soil-card { padding: 20px; }
            .soil-value { font-size: 2rem; }
            .crop-card { padding: 24px; }
            .crop-icon { width: 64px; height: 64px; font-size: 2.5rem; }
        }
        
        @media (max-width: 480px) {
            body { padding: 15px; }
            header h1 { font-size: 1.6rem; }
            .nav-links { gap: 8px; }
            .nav-links a { padding: 6px 10px; font-size: 0.8rem; }
            .category-tabs { gap: 6px; }
            .category-tab { padding: 8px 12px; font-size: 0.8rem; }
            .season-card { padding: 20px; }
            .season-icon { font-size: 2.5rem; }
            .season-title { font-size: 1.2rem; }
            .crop-card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå± SoilSense</h1>
            <p>üáµüá≠ Philippine Crop Suggestions</p>
        </header>
        
        <nav class="nav-links">
            <a href="/dashboard">üè† Dashboard</a>
            <a href="/crops" class="active">üåæ Crops</a>
            <a href="/history">üìä History</a>
            <a href="/my-plants">ü™¥ My Plants</a>
            <a href="/account">üë§ Account</a>
            <a href="/logout">üö™ Logout</a>
        </nav>
        
        <!-- Current Season -->
        <div class="season-card dry" id="seasonCard">
            <div class="season-icon" id="seasonIcon">‚òÄÔ∏è</div>
            <div class="season-title" id="seasonTitle">Loading...</div>
            <div class="season-months" id="seasonMonths">--</div>
            <div class="season-desc" id="seasonDesc">--</div>
        </div>
        
        <!-- Soil Moisture -->
        <div class="soil-card">
            <h3>üíß Your Average Soil Moisture</h3>
            <div class="soil-value"><span id="soilValue">--</span>%</div>
            <div class="soil-label">Based on sensor history</div>
        </div>
        
        <!-- Crop Suggestions Slider -->
        <div class="suggestions-header">
            <h2>üåæ Recommended Crops</h2>
            <button class="refresh-btn" onclick="loadSuggestions()">üîÑ Refresh</button>
        </div>
                
        <!-- CATEGORY TABS -->
        <div class="category-tabs">
            <div class="category-tab active" data-category="all" onclick="filterByCategory('all')">
                üåü All Plants
            </div>
            <div class="category-tab" data-category="vegetables" onclick="filterByCategory('vegetables')">
                ü•¨ Vegetables
            </div>
            <div class="category-tab" data-category="fruits" onclick="filterByCategory('fruits')">
                üçá Fruits
            </div>
            <div class="category-tab" data-category="flowers" onclick="filterByCategory('flowers')">
                üå∫ Flowers
            </div>
        </div>
        
        <div id="cropsContainer" class="loading">
            <div class="spinner"></div>
            <p>Loading crop suggestions...</p>
        </div>
        
        <div class="info-note">
            üí° Crops are recommended based on Philippine season (Dry: Nov-May, Wet: Jun-Oct) and your soil moisture data.
        </div>
    </div>

    <script>
        let currentSlide = 0;
        let totalSlides = 0;
        let cropsData = [];
        let allCropsData = []; // Store all crops
        let currentCategory = 'all'; // Track current category
        
        // Maximum number of slides to display
        const MAX_SLIDES = 10;
        
        // Define category IDs (matching your Python CROPS_DATABASE)
        const flowerIds = ['sampaguita', 'santan', 'gumamela', 'rosal', 'marigold', 
                           'sunflower', 'zinnia', 'bougainvillea', 'adelfa', 'kalachuchi',
                           'waling_waling', 'vanda', 'caladium', 'anthurium', 'cosmos', 
                           'dama_de_noche', 'cadena_de_amor', 'yellow_bell'];
        
        const fruitIds = ['papaya', 'mango', 'calamansi', 'guava', 'pineapple', 
                          'dragon_fruit', 'coconut', 'jackfruit', 'durian', 'rambutan', 
                          'lanzones', 'starfruit', 'soursop', 'santol', 'atis', 'chico', 
                          'duhat', 'macopa', 'watermelon', 'cantaloupe', 'banana'];
        
        // ADD TO MY PLANTS FUNCTION
        async function addToMyPlants(plantId, plantName, plantIcon) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding...';
            
            try {
                const response = await fetch('/api/my_plants/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        plant_id: plantId,
                        plant_name: plantName,
                        plant_icon: plantIcon
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    btn.textContent = '‚úÖ Added to My Plants!';
                    btn.style.background = '#22c55e';
                    setTimeout(() => {
                        btn.textContent = '‚ûï Add to My Plants';
                        btn.style.background = '#4ade80';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert('‚ö†Ô∏è ' + (data.error || 'Could not add plant'));
                    btn.textContent = '‚ûï Add to My Plants';
                    btn.disabled = false;
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                btn.textContent = '‚ûï Add to My Plants';
                btn.disabled = false;
            }
        }
        
        // FILTER BY CATEGORY
        function filterByCategory(category) {
            currentCategory = category;
            
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Filter crops
            let filteredCrops = [];
            if (category === 'all') {
                filteredCrops = allCropsData;
            } else if (category === 'vegetables') {
                filteredCrops = allCropsData.filter(crop => 
                    !flowerIds.includes(crop.id) && !fruitIds.includes(crop.id)
                );
            } else if (category === 'fruits') {
                filteredCrops = allCropsData.filter(crop => fruitIds.includes(crop.id));
            } else if (category === 'flowers') {
                filteredCrops = allCropsData.filter(crop => flowerIds.includes(crop.id));
            }
            
            // Limit to MAX_SLIDES
            cropsData = filteredCrops.slice(0, MAX_SLIDES);
            totalSlides = cropsData.length;
            currentSlide = 0;
            
            if (totalSlides > 0) {
                renderSlider();
            } else {
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                document.getElementById('cropsContainer').innerHTML = `
                    <div class="no-suggestions">
                        <div class="icon">üå±</div>
                        <h3>No ${categoryName} Found</h3>
                        <p>Try selecting a different category.</p>
                    </div>
                `;
            }
        }
        
        async function loadSuggestions() {
            const container = document.getElementById('cropsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
            
            try {
                const response = await fetch('/api/crop_suggestions');
                const data = await response.json();
                
                // Update season card
                const seasonCard = document.getElementById('seasonCard');
                const season = data.season || {};
                const isWet = season.season_type === 'wet';
                
                seasonCard.className = 'season-card ' + (isWet ? 'wet' : 'dry');
                document.getElementById('seasonIcon').textContent = season.icon || (isWet ? 'üåßÔ∏è' : '‚òÄÔ∏è');
                document.getElementById('seasonTitle').textContent = season.season || 'Unknown';
                document.getElementById('seasonMonths').textContent = season.months || '--';
                document.getElementById('seasonDesc').textContent = season.description || '--';
                
                // Update soil moisture
                document.getElementById('soilValue').textContent = data.soil_moisture ?? '--';
                
                // Store all crops data
                allCropsData = data.suggestions || [];
                
                // Apply current category filter
                filterByCategory(currentCategory);
                
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `
                    <div class="no-suggestions">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Data</h3>
                        <p>Please try again.</p>
                    </div>
                `;
            }
        }
        
        function renderSlider() {
            const container = document.getElementById('cropsContainer');
            
            // Get total filtered crops (before limit) to show if there are more
            let totalFiltered = 0;
            if (currentCategory === 'all') {
                totalFiltered = allCropsData.length;
            } else if (currentCategory === 'vegetables') {
                totalFiltered = allCropsData.filter(crop => 
                    !flowerIds.includes(crop.id) && !fruitIds.includes(crop.id)
                ).length;
            } else if (currentCategory === 'fruits') {
                totalFiltered = allCropsData.filter(crop => fruitIds.includes(crop.id)).length;
            } else if (currentCategory === 'flowers') {
                totalFiltered = allCropsData.filter(crop => flowerIds.includes(crop.id)).length;
            }
            
            let slidesHTML = cropsData.map((crop, index) => `
                <div class="slide">${renderCropCard(crop)}</div>
            `).join('');
            
            let dotsHTML = cropsData.map((_, index) => `
                <div class="dot ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>
            `).join('');
            
            const moreCropsNote = totalFiltered > MAX_SLIDES ? 
                `<div style="text-align: center; color: #94a3b8; font-size: 0.85rem; margin-top: 10px;">
                    Showing top ${MAX_SLIDES} of ${totalFiltered} crops
                </div>` : '';
            
            container.innerHTML = `
                <div class="slider-container">
                    <div class="slider-wrapper" id="sliderWrapper">
                        ${slidesHTML}
                    </div>
                </div>
                <div class="slider-controls">
                    <button class="slider-btn" id="prevBtn" onclick="prevSlide()">‚óÄ</button>
                    <div class="slider-dots" id="sliderDots">
                        ${dotsHTML}
                    </div>
                    <button class="slider-btn" id="nextBtn" onclick="nextSlide()">‚ñ∂</button>
                </div>
                <div class="slide-counter">
                    <span id="currentSlideNum">1</span> / <span id="totalSlideNum">${totalSlides}</span>
                </div>
                ${moreCropsNote}
            `;
            
            updateSlider();
        }
        
        function updateSlider() {
            const wrapper = document.getElementById('sliderWrapper');
            if (wrapper) {
                wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
            }
            
            // Update dots
            const dots = document.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
            
            // Update counter
            const counterEl = document.getElementById('currentSlideNum');
            if (counterEl) {
                counterEl.textContent = currentSlide + 1;
            }
            
            // Update buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            if (prevBtn) prevBtn.disabled = currentSlide === 0;
            if (nextBtn) nextBtn.disabled = currentSlide === totalSlides - 1;
        }
        
        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
                updateSlider();
            }
        }
        
        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                updateSlider();
            }
        }
        
        function goToSlide(index) {
            currentSlide = index;
            updateSlider();
        }
        
        function renderCropCard(crop) {
            const scoreClass = crop.score >= 70 ? 'high' : crop.score >= 50 ? 'medium' : 'low';
            const seasonLabel = {
                'wet': 'üåßÔ∏è Wet Season',
                'dry': '‚òÄÔ∏è Dry Season',
                'both': 'üîÑ Year-round'
            }[crop.season_type] || 'Year-round';
            
            // Escape quotes in the onclick attributes
            const safeName = crop.name.replace(/'/g, "\\'");
            
            return `
                <div class="crop-card">
                    <div class="crop-header">
                        <div class="crop-icon">${crop.icon}</div>
                        <div class="crop-info">
                            <h3>${crop.name}</h3>
                            <div class="local-name">${crop.local_name}</div>
                            <div class="crop-score">
                                <div class="score-bar">
                                    <div class="score-fill ${scoreClass}" style="width: ${crop.score}%"></div>
                                </div>
                                <span class="score-text">${crop.score}% match</span>
                            </div>
                        </div>
                    </div>
                    <span class="crop-season-tag ${crop.season_type}">${seasonLabel}</span>
                    <p class="crop-description">${crop.description}</p>
                    <div class="crop-tips">
                        <div class="tip-label">üí° TIPS</div>
                        <div class="tip-text">${crop.tips}</div>
                    </div>
                    <div class="crop-soil">
                        <div class="label">üíß Ideal Soil Moisture</div>
                        <div class="value">${crop.ideal_soil}</div>
                    </div>
                    <div class="crop-reasons">
                        ${crop.reasons.map(r => `<span class="reason-tag">${r}</span>`).join('')}
                    </div>
                    <button class="add-to-plants-btn" onclick="addToMyPlants('${crop.id}', '${safeName}', '${crop.icon}')">
                        ‚ûï Add to My Plants
                    </button>
                </div>
            `;
        }
        
        // Swipe support for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    nextSlide();
                } else {
                    prevSlide();
                }
            }
        }
        
        // Keyboard support
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowRight') nextSlide();
            if (e.key === 'ArrowLeft') prevSlide();
        });
        
        loadSuggestions();
    </script>
</body>
</html>
